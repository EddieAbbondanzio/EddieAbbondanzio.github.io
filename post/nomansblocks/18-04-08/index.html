<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>No Mans Blocks - 4/8/18</title>
    <meta name="description" content="I build things. Sometimes good.">
        
    

    
    
    <link rel="stylesheet" href="https://eddieabbondanz.io/sass/main.min.2ba91e557a411cfb5bcfaee003c60eff46537304f83d0ea33f9a47c454d53cdc.css" integrity="sha256-K6keVXpBHPtbz67gA8YO/0ZTcwT4PQ6jP5pHxFTVPNw=" media="screen">

    <script src="https://eddieabbondanz.io/js/interactivity.js"></script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128571017-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

<body class="has-background-light">
    

        <section class="hero is-halfheight is-primary">
            

            <div class="hero-head"><nav class="navbar is-transparent is-spaced" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item title is-uppercase is-marginless has-text-white is-size-5" href="https://eddieabbondanz.io">
            EddieAbbondanz.io
        </a>

        <a
            role="button"
            class="navbar-burger burger has-text-white"
            aria-label="menu"
            aria-expanded="false"
            data-target="hamburger-menu"
        >
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>

    <div class="navbar-menu has-text-white">
        <div class="navbar-end">
             
            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link has-text-white"> Posts </a>

                <div class="navbar-dropdown">
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/post/"> All </a>

                    
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/series/a-software-distopia"> A Software Distopia </a>
                    
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/series/the-disillusioned-developer"> The Disillusioned Developer </a>
                    
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/series/xj-build"> XJ Build </a>
                    
                </div>
            </div>

              
            <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/about" style="text-decoration: none !important"
                >About Me</a
            >
              
            <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/portfolio" style="text-decoration: none !important"
                >Portfolio</a
            >
              
            <a class="navbar-item has-text-white" href="http://github.com/EddieAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-github fa-lg"></i>
                </span>
            </a>
             
            <a class="navbar-item has-text-white" href="https://twitter.com/EAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-twitter fa-lg"></i>
                </span>
            </a>
            
            <a class="navbar-item has-text-white" href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-linkedin fa-lg"></i>
                </span>
            </a>
            
        </div>
    </div>

    <div id="hamburger-menu" class="navbar-menu is-hidden-desktop">
         

        <div class="has-dropdown is-hoverable">
            <a class="navbar-link has-text-white is-arrowless"> Posts </a>

            <div class="navbar-dropdown">
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/post/"> All </a>

                
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/series/a-software-distopia"> A Software Distopia </a>
                
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/series/the-disillusioned-developer"> The Disillusioned Developer </a>
                
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/series/xj-build"> XJ Build </a>
                
            </div>
        </div>
         
        <a class="navbar-item" href="https://eddieabbondanz.io/about" style="text-decoration: none !important">About Me</a>
         
        <a class="navbar-item" href="https://eddieabbondanz.io/portfolio" style="text-decoration: none !important">Portfolio</a>
        

        <div class="is-flex is-flex-direction-row is-justify-content-space-evenly">
            
            <a class="navbar-item" href="http://github.com/EddieAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-github fa-lg"></i>
                </span>
            </a>
             
            <a class="navbar-item" href="https://twitter.com/EAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-twitter fa-lg"></i>
                </span>
            </a>
            
            <a class="navbar-item" href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-linkedin fa-lg"></i>
                </span>
            </a>
            
        </div>
    </div>
</nav>
</div>

            <div class="hero-foot">
                <div class="container"><header>
    <div class="post-header has-text-white has-margin-all-4-touch has-margin-bottom-4-desktop">
        
        <div class="has-margin-bottom-0">
            
            <h1 class="has-margin-bottom-0 is-size-2 is-size-4-touch">No Mans Blocks - 4/8/18</h1>
               
        </div>

        
        
        <div class="is-flex is-flex-direction-row">
            
            <div class="is-flex-desktop flex-row has-text-grey-lighter">
                <div class="is-flex is-flex-row is-align-items-baseline has-margin-right-3" title="Date posted">
                    <i class="fas fa-calendar-day has-text-grey-light has-margin-right-1"></i>
                    <time class="has-text-grey-lighter">Apr 8, 2018</time>
                </div>
            </div>
             
        </div>
        
    </div>
</header>
</div>
            </div>
        </section>
    </section>
</section>


    <main class="container has-background-white">
        
<article>
    <h2 id="building-up-the-network-logic">Building Up the Network Logic</h2>
<p>While this week may not have much to show for it has built a solid foundation for networking. I spent some time refactoring the pre-existing network logic to try to clean things up. I really didn&rsquo;t like how the NetServerManager and NetClientManager derived from a base class of NetManager that had a NetMessageProcessor component. It was gross having to call that and subscribe to it&rsquo;s message events. I also didn&rsquo;t care for how each message had it&rsquo;s own event. To try to curtail this redundancy I came up with the following solution.</p>
<p>This networking set up is built on top of the Lidgren networking library. I wanted to abstract away from the Lidgren aspect since it&rsquo;s kinda low level, but I didn&rsquo;t want to go over the top at the same time. I based my setup from this <a href="https://dirkkok.wordpress.com/2012/02/20/lets-make-a-multiplayer-game-part-1/">site&rsquo;s</a> tutorial and applied a few custom tweaks to it.</p>
<p>To reduce redundant code and prevent potential logic errors from arising I changed NetMessage to an abstract class, and added a message category to the class. Now instead of requiring an unique event for each message type I only had to add one per category. Since most components of the game would require several messages it made sense to group them together instead of having to track multiple events per component.</p>
<p>The NetManager base class is responsible for checking and sending out message over the network. It allows for the server and client to be abstract away from the regular game logic as well. Below is the method for checking for messages.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Check to see if any messages have come in from the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> CheckForMessages() {
    NetIncomingMessage inMsg;

    <span style="color:#66d9ef">while</span>((inMsg = ReadMessage()) != <span style="color:#66d9ef">null</span>) {
        NetMessage recievedMsg = NetMessage.DecodeMessage(inMsg);

        <span style="color:#75715e">//Sometimes we don&#39;t actually have a network message to process.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(recievedMsg == <span style="color:#66d9ef">null</span>) {
            <span style="color:#66d9ef">continue</span>;
        }

        <span style="color:#66d9ef">switch</span> (recievedMsg.Category) {
            <span style="color:#66d9ef">case</span> NetMessageCategory.Connection:
                <span style="color:#66d9ef">if</span>(OnConnectionMessage != <span style="color:#66d9ef">null</span>) {
                    OnConnectionMessage(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> NetMessageArgs(recievedMsg));
                }
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> NetMessageCategory.Info:
                <span style="color:#66d9ef">if</span>(OnInfoMessage != <span style="color:#66d9ef">null</span>) {
                    OnInfoMessage(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> NetMessageArgs(recievedMsg));
                }
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> NetMessageCategory.Lobby:
                <span style="color:#66d9ef">if</span>(OnLobbyMessage != <span style="color:#66d9ef">null</span>) {
                    OnLobbyMessage(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> NetMessageArgs(recievedMsg));
                }
                <span style="color:#66d9ef">break</span>;
        }

        Recycle(inMsg);
    }
}
</code></pre></div><p>As each category is added this will be expanded upon but I can&rsquo;t see there being too many categories. By the end of this coming week I should have all lobby data synced along with a working chat system. This may seem fairly basic, and it really is because most of the magic is occuring in NetMessage.DecodeMessage(). DecodeMessage is similar to the factory pattern as it is responsible for creating every message recieved over the net.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Decode a message that was recieved from over the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> NetMessage DecodeMessage(NetIncomingMessage inMsg) {
    <span style="color:#66d9ef">switch</span> (inMsg.MessageType) {
        <span style="color:#66d9ef">case</span> NetIncomingMessageType.VerboseDebugMessage:
        <span style="color:#66d9ef">case</span> NetIncomingMessageType.DebugMessage:
        <span style="color:#66d9ef">case</span> NetIncomingMessageType.WarningMessage:
        <span style="color:#66d9ef">case</span> NetIncomingMessageType.ErrorMessage:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InfoMessage(inMsg);

        <span style="color:#66d9ef">case</span> NetIncomingMessageType.ConnectionApproval:
        <span style="color:#66d9ef">case</span> NetIncomingMessageType.StatusChanged:
            <span style="color:#66d9ef">return</span> DecodeConnectionMessage(inMsg);

        <span style="color:#66d9ef">case</span> NetIncomingMessageType.Data:
        <span style="color:#66d9ef">case</span> NetIncomingMessageType.UnconnectedData:
            <span style="color:#66d9ef">return</span> DecodeDataMessage(inMsg);

        <span style="color:#66d9ef">default</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }
}
</code></pre></div><p>It takes an input of NetIncomingMessage (lidgren&rsquo;s message class) and converts them into the new custom message that is specialized. Info messages are nothing more than a string so they can be returned instantly. Things get a bit trickier with connection messages, and data messages though.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Decodes a connection message such as connection request, connect,
</span><span style="color:#75715e">/// or disconnect that was recieved from over the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> NetMessage DecodeConnectionMessage(NetIncomingMessage inMsg) {
    <span style="color:#66d9ef">if</span> (inMsg == <span style="color:#66d9ef">null</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }

    NetMessage connMsg = <span style="color:#66d9ef">null</span>;

    <span style="color:#75715e">//New client wants to connect
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (inMsg.MessageType == NetIncomingMessageType.ConnectionApproval) {
        connMsg = <span style="color:#66d9ef">new</span> ConnectionRequestMessage(inMsg);
    }
    <span style="color:#75715e">//Client has fully connected, or wants to disconnect
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (inMsg.MessageType == NetIncomingMessageType.StatusChanged) {
        NetConnectionStatus senderStatus = inMsg.SenderConnection.Status;

        <span style="color:#75715e">//Fully connected new client
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (senderStatus == NetConnectionStatus.Connected) {
            connMsg = <span style="color:#66d9ef">new</span> ConnectMessage(inMsg);
        }
        <span style="color:#75715e">//Old client leaving
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (senderStatus == NetConnectionStatus.Disconnected) {
            connMsg = <span style="color:#66d9ef">new</span> DisconnectMessage(inMsg);
        }
    }

    <span style="color:#66d9ef">return</span> connMsg;
}
</code></pre></div><p>This method handles a few different tasks. It&rsquo;s responsible for processing ConnectionRequest, Connected, and Disconnect messages. A ConnectionRequestMessage occurs when a new client wants to join the server. This allows the server to get the player&rsquo;s desired name, and check if they are a known banned connection. Connection messages are nothing more than an acknowledgement that the client has joined in, but perhaps in the future they&rsquo;ll have some data attached to them. A Disconnect message is also nothing more than a courtesy to server instead of having the client time out.</p>
<p>Rebuilding data messages is simpler. It&rsquo;s nothing more than a switch statement that reads the first byte of each message to get the NetMessageType.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Decodes a custom data message that was recieved from over the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> NetMessage DecodeDataMessage(NetIncomingMessage inMsg) {
    NetMessageType msgType = (NetMessageType)inMsg.ReadByte();

    <span style="color:#66d9ef">switch</span> (msgType) {
        <span style="color:#66d9ef">case</span> NetMessageType.Chat:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> NetChatMessage(inMsg);

        <span style="color:#66d9ef">case</span> NetMessageType.Command:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CommandMessage(inMsg);

        <span style="color:#66d9ef">case</span> NetMessageType.LobbySync:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> LobbySyncMessage(inMsg);

        <span style="color:#66d9ef">case</span> NetMessageType.PlayerJoined:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PlayerJoinedMessage(inMsg);

        <span style="color:#66d9ef">case</span> NetMessageType.PlayerLeft:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PlayerLeftMessage(inMsg);

        <span style="color:#66d9ef">default</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }
}
</code></pre></div><p>In the near future once the network is solidified I plan on writing up a nice networking tutorial with Lidgren and Unity to help out others.</p>

</article>

    </main>

    <footer>
    <p>&copy; 2021 <a href="https://eddieabbondanz.io">Eddie Abbondanzio</a></p>
</footer> </body>
</html>