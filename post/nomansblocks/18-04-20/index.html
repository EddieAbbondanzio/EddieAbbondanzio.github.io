<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>No Mans Blocks - 4/20/18</title>
  
  <meta name="description" content="My blog about my project cars and other contraptions">
  
  <meta name="author" content="Eddie Abbondanzio">
  

  
  
  <link rel="stylesheet" href="https://eddieabbondanz.io/sass/index.min.79526dae8d29fab82bb520e28634f9db92f9ed4cda79daa0ddbf5508bedda33d.css" integrity="sha256-eVJtro0p&#43;rgrtSDihjT525L57Uzaedqg3b9VCL7doz0=" media="screen">

  <link rel="stylesheet" href="https://eddieabbondanz.io//widgets/_plugin-vue_export-helper.css">

  <script data-goatcounter="https://tgpo.eddieabbondanz.io/count" async src="//tgpo.eddieabbondanz.io/count.js"></script>
</head>

<body>
  <nav class="navbar fr jcsb aic mt2-phone">
  <div class="title h100 fr aic">
    <a href="https://eddieabbondanz.io/">
      <img class="avatar mr2" src="https://eddieabbondanz.io/img/avatar.jpg" />
    </a>

    <a class="tdn fwb" href="https://eddieabbondanz.io/">
      <span>Eddie Abbondanzio</span>
    </a>
  </div>

  <div id="desktop-search" class="pr2 hidden-phone">
    
  </div>

  <div class="menu h100 aic fr-tablet dn-phone">
     
    <div class="item dropdown">
      <a class="trigger"
        >Blog
        <span class="icon"><i class="fas fa-chevron-down"></i></span>
      </a>
      <div class="content-wrapper">
        <div class="content">
          <a href="https://eddieabbondanz.io/post/"> All </a>

          
          <a href="https://eddieabbondanz.io/series/development">Development</a>
          
          <a href="https://eddieabbondanz.io/series/ls-xj-build">LS XJ Build</a>
          
          <a href="https://eddieabbondanz.io/series/oem&#43;-xj-build">OEM&#43; XJ Build</a>
          
          <a href="https://eddieabbondanz.io/series/93-eg-hatch-build">93 EG Hatch Build</a>
          
          <a href="https://eddieabbondanz.io/series/88-integra-build">88 Integra Build</a>
          
          <a href="https://eddieabbondanz.io/series/honda-info-and-diys">Honda Info and DIYs</a>
          
          <a href="https://eddieabbondanz.io/series/xj-info-and-diys">XJ Info and DIYs</a>
          
          <a href="https://eddieabbondanz.io/series/shop-and-tools">Shop and Tools</a>
          
        </div>
      </div>
    </div>
      
    <a class="item single" href="https://eddieabbondanz.io/app">Apps</a>
      
    <a class="item single" href="https://eddieabbondanz.io/about">About</a>
     
    <div class="item social h100 fr aic px3">
      
      <a href="http://github.com/EddieAbbondanzio" target="_blank" title="GitHub">
        <span class="icon">
          <i class="fab fa-github fa-lg"></i>
        </span>
      </a>
      
      <a href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank" title="Linkedin">
        <span class="icon">
          <i class="fab fa-linkedin fa-lg"></i>
        </span>
      </a>
      
    </div>
  </div>

  <a id="hamburger" class="hamburger" href="#">
    <span class="icon">
      <i class="fa fa-bars fa-lg"></i>
    </span>
  </a>
</nav>

  
<div id="hamburger-menu" class="hamburger-menu">
   

  <div>
    <div id="phone-search" class="mt2">
      
    </div>
    
    <div class="ml2">
      <a href="https://eddieabbondanz.io/post/"> All </a>

      
      <a href="https://eddieabbondanz.io/series/development"> Development </a>
      
      <a href="https://eddieabbondanz.io/series/ls-xj-build"> LS XJ Build </a>
      
      <a href="https://eddieabbondanz.io/series/oem&#43;-xj-build"> OEM&#43; XJ Build </a>
      
      <a href="https://eddieabbondanz.io/series/93-eg-hatch-build"> 93 EG Hatch Build </a>
      
      <a href="https://eddieabbondanz.io/series/88-integra-build"> 88 Integra Build </a>
      
      <a href="https://eddieabbondanz.io/series/honda-info-and-diys"> Honda Info and DIYs </a>
      
      <a href="https://eddieabbondanz.io/series/xj-info-and-diys"> XJ Info and DIYs </a>
      
      <a href="https://eddieabbondanz.io/series/shop-and-tools"> Shop and Tools </a>
      
    </div>
  </div>
   
  <a href="https://eddieabbondanz.io/app">Apps</a>
   
  <a href="https://eddieabbondanz.io/about">About</a>
  

  <div class="fr jcse">
    
    <a href="http://github.com/EddieAbbondanzio" target="_blank">
      <span class="icon is-medium">
        <i class="fab fa-github fa-lg"></i>
      </span>
    </a>
    
    <a href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
      <span class="icon is-medium">
        <i class="fab fa-linkedin fa-lg"></i>
      </span>
    </a>
    
  </div>
</div>

  <main>
    
<article class="post" data-pagefind-meta="image:">
  <h1 class="h1 mb2" data-pagefind-meta="title">
    
    No Mans Blocks - 4/20/18
  </h1>

  <div class="fr meta pb3">
    
    <a class="mr1ch tdn" href="https://eddieabbondanz.io/series/development" title="More Development posts">
      <i class="fas fa-th-list"></i>
      Development
    </a>
    

    
    <div class="date" title="Posted on Apr 20, 2018">
      <i class="fas fa-calendar-day"></i>
      <time>Apr 20, 2018</time>
    </div>
    
  </div>

  <div class="markdown-body" data-pagefind-body>
    <h2>
  Playing Around at the Bit Level
  <a href="#playing-around-at-the-bit-level" id="playing-around-at-the-bit-level" class="anchor" aria-hidden="true"><i class="fa fa-link"></i></a>
</h2><p>This weeks adventure has been exploring object serialization. Initially I was using the serializable attribute to convert my objects into byte arrays but for some objects such as the voxel chunks this is far from ideal. Since I don&rsquo;t want to handle serialization with 2 different methods I&rsquo;ve decided to bite the bullet and roll my own set up.</p>
<p>To help prepare for this task I&rsquo;ve created a BitManipulator class that allows for individual bits to be written to in a byte array. This was done to allow for writing bools as single bits vew an entire byte. The BitManipulator will be used by the ByteBuffer to help pack data as tight as possible for network traversal.</p>
<p>To limit the use of the bit manipulator it only allows for writing between 1 to 8 bits at a time. Any more than that would be unreasonable since it would be no different than writing bytes. Also by setting the upper limit to 8 it only requires us to handle 2 cases. The first when modifying only 1 byte, and the second where two (adjacent) bytes are being modified.</p>
<p>Reading bits is fairly simple.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span> ReadBits(<span style="color:#66d9ef">byte</span>[] bytes, <span style="color:#66d9ef">int</span> bitIndex, <span style="color:#66d9ef">int</span> bitCount) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Ensure valid use of the method.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (bitCount &lt; <span style="color:#ae81ff">1</span> || bitCount &gt; <span style="color:#ae81ff">8</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Bit count should be within the range of 1 to 8!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Figure out byte index, and where to start in the byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> byteIndex = bitIndex / <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> bitOffset = bitIndex % <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Reading from 1 byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (bitCount + bitOffset &lt;= <span style="color:#ae81ff">8</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Build the mask</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span> mask = (<span style="color:#66d9ef">byte</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Get the bits and shift them to proper location.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">byte</span>)((bytes[byteIndex] &amp; mask) &gt;&gt; bitOffset);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Reading from 2 bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Gets the two bytes combined</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">value</span> = SerializeUtils.GetShort(bytes, byteIndex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Then we can pull out the data we want.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">short</span> mask = (<span style="color:#66d9ef">short</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">byte</span>)((<span style="color:#66d9ef">value</span> &amp; mask) &gt;&gt; bitOffset);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Writing bits is only a little more challenging.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> WriteBits(<span style="color:#66d9ef">byte</span>[] bytes, <span style="color:#66d9ef">int</span> bitIndex, <span style="color:#66d9ef">int</span> bitCount, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">value</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Ensure valid use of the method.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (bitCount &lt; <span style="color:#ae81ff">1</span> || bitCount &gt; <span style="color:#ae81ff">8</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Bit count should be within the range of 1 to 8!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Divide it by 8, and find bit offset.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> byteIndex = bitIndex / <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> bitOffset = bitIndex % <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Writing into 1 byte case</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (bitCount + bitOffset &lt;= <span style="color:#ae81ff">8</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//shift to account for offset</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">value</span> &lt;&lt;= bitOffset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Build the mask</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span> mask = (<span style="color:#66d9ef">byte</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        bytes[byteIndex] &amp;= (<span style="color:#66d9ef">byte</span>)~mask;
</span></span><span style="display:flex;"><span>        bytes[byteIndex] |= <span style="color:#66d9ef">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Writing into 2 bytes case</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Build a short</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">short</span> splitVal = (<span style="color:#66d9ef">short</span>)(<span style="color:#66d9ef">value</span> &lt;&lt; bitOffset);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">short</span> mask = (<span style="color:#66d9ef">short</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Wipe the bits</span>
</span></span><span style="display:flex;"><span>        bytes[byteIndex] &amp;= (<span style="color:#66d9ef">byte</span>)~mask;
</span></span><span style="display:flex;"><span>        bytes[byteIndex] |= (<span style="color:#66d9ef">byte</span>)splitVal;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Write the bits</span>
</span></span><span style="display:flex;"><span>        bytes[byteIndex + <span style="color:#ae81ff">1</span>] &amp;= (<span style="color:#66d9ef">byte</span>)~(mask &gt;&gt; <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        bytes[byteIndex + <span style="color:#ae81ff">1</span>] |= (<span style="color:#66d9ef">byte</span>)(splitVal &gt;&gt; <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I played around with using a short pointer for writing bits but it didn&rsquo;t seem worth it to require the unsafe compile flag for a single method. It was still a fun task though. I&rsquo;ve also learned about the joys of Unit Testing and have started using it for validating all my serialization methods. Once details are a little more concrete regarding the ByteBuffer set up I&rsquo;ll provide a detailed write up on it.</p>

  </div>
</article>

  </main>

  <footer>
  <p>&copy; 2013 - 2025 Eddie Abbondanzio</p>
</footer>
  <script src="https://eddieabbondanz.io/js/lol.js"></script>
  <link href="https://eddieabbondanz.io/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="https://eddieabbondanz.io/pagefind/pagefind-ui.js"></script>

<script>
  const DRAWER_QUERY = ".pagefind-ui__drawer"

  
  window.addEventListener('DOMContentLoaded', (event) => {
    initDesktopSearchBar();
    initPhoneSearchBar();
  });

  function initDesktopSearchBar() {
    new PagefindUI({
      element: "#desktop-search", 
      showSubResults: false, 
      pageSize: 10, 
      translations: {
        placeholder: "Search posts"
      } 
    });

    
    const input = document.querySelector("#desktop-search input")
    input.addEventListener("focus", () => {
      const drawer = document.querySelector(DRAWER_QUERY)
      if(drawer) {
        drawer.classList.remove("hidden")
      }
    })

    
    window.addEventListener("click", (ev) => {
      if(!ev.target.closest("#desktop-search")) {
        const drawer = document.querySelector(DRAWER_QUERY)
        drawer.classList.add("hidden")
      }
    })
  }

  function initPhoneSearchBar() {
    new PagefindUI({
      element: "#phone-search", 
      showSubResults: false, 
      pageSize: 10, 
      translations: {
        placeholder: "Search posts"
      } 
    });

        
    const input = document.querySelector("#desktop-search input")
    input.addEventListener("focus", () => {
      const drawer = document.querySelector(DRAWER_QUERY)
      if(drawer) {
        drawer.classList.remove("hidden")
      }
    })

    
    window.addEventListener("click", (ev) => {
      if(!ev.target.closest("#desktop-search")) {
        const drawer = document.querySelector(DRAWER_QUERY)
        drawer.classList.add("hidden")
      }
    })

  }
</script>
</body>

</html>