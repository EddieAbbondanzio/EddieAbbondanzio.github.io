<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>No Mans Blocks - 4/20/18</title>
  
  
  

  
  
  <link rel="stylesheet" href="https://eddieabbondanz.io/sass/index.min.e9a72d3874c72d5524441b58f39e1593e629371cb417d0812963d9946cb8556b.css" integrity="sha256-6actOHTHLVUkRBtY854Vk&#43;YpNxy0F9CBKWPZlGy4VWs=" media="screen">

  <script data-goatcounter="https://tgpo.eddieabbondanz.io/count" async
    src="//tgpo.eddieabbondanz.io/count.js"></script>

</head>

<body>
  <nav class="navbar fr jcsb aic mt2-phone">
  <a class="title h100 fr aic tdn fwb" href="https://eddieabbondanz.io">
    <img class="avatar mr2" src="https://eddieabbondanz.io/img/avatar.jpg" />
    Eddie Abbondanzio
  </a>

  <div class="menu h100 aic fr-tablet dn-phone">
    
    
    <div class="item dropdown">
      <a class="trigger" href="https://eddieabbondanz.io/post">Blog
        <span class="icon"><i class="fas fa-chevron-down"></i></span>
      </a>

      <div class="content">
        <a href="https://eddieabbondanz.io/post/"> All </a>

        
        <a href="https://eddieabbondanz.io/series/development"> Development </a>
        
        <a href="https://eddieabbondanz.io/series/xj-build"> 00 XJ Build </a>
        
        <a href="https://eddieabbondanz.io/series/93-eg-hatch-build"> 93 EG Hatch Build </a>
        
        <a href="https://eddieabbondanz.io/series/88-integra-build"> 88 Integra Build </a>
        
        <a href="https://eddieabbondanz.io/series/honda-info-and-diys"> Honda Info and DIYs </a>
        
        <a href="https://eddieabbondanz.io/series/xj-info-and-diys"> XJ Info and DIYs </a>
        
        <a href="https://eddieabbondanz.io/series/shop-and-tools"> Shop and Tools </a>
        
      </div>
    </div>
    
    
    
    <a class="item single" href="https://eddieabbondanz.io/app">Apps</a>
    
    
    
    <a class="item single" href="https://eddieabbondanz.io/about">About</a>
    
    
    <div class="item social h100 fr aic px3">
      
      <a href="http://github.com/EddieAbbondanzio" target="_blank" title="GitHub">
        <span class="icon">
          <i class="fab fa-github fa-lg"></i>
        </span>
      </a>
      
      <a href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank" title="Linkedin">
        <span class="icon">
          <i class="fab fa-linkedin fa-lg"></i>
        </span>
      </a>
      
    </div>
  </div>

  <a id="hamburger" class="hamburger " href="#" title="Linkedin">
    <span class="icon">
      <i class="fa fa-bars fa-lg"></i>
    </span>
  </a>

</nav>
  <div id="hamburger-menu" class="hamburger-menu">
     

    <div>
      <a> Blog </a>

      <div class="ml2">
        <a href="https://eddieabbondanz.io/post/"> All </a>

        
        <a href="https://eddieabbondanz.io/series/development"> Development </a>
        
        <a href="https://eddieabbondanz.io/series/xj-build"> 00 XJ Build </a>
        
        <a href="https://eddieabbondanz.io/series/93-eg-hatch-build"> 93 EG Hatch Build </a>
        
        <a href="https://eddieabbondanz.io/series/88-integra-build"> 88 Integra Build </a>
        
        <a href="https://eddieabbondanz.io/series/honda-info-and-diys"> Honda Info and DIYs </a>
        
        <a href="https://eddieabbondanz.io/series/xj-info-and-diys"> XJ Info and DIYs </a>
        
        <a href="https://eddieabbondanz.io/series/shop-and-tools"> Shop and Tools </a>
        
      </div>
    </div>
     
    <a href="https://eddieabbondanz.io/app">Apps</a>
     
    <a href="https://eddieabbondanz.io/about">About</a>
    

    <div class="fr jcse">
      
      <a href="http://github.com/EddieAbbondanzio" target="_blank">
        <span class="icon is-medium">
          <i class="fab fa-github fa-lg"></i>
        </span>
      </a>
      
      <a href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
        <span class="icon is-medium">
          <i class="fab fa-linkedin fa-lg"></i>
        </span>
      </a>
      
    </div>
  </div>

  <main>
    
    <h1 class="title">No Mans Blocks - 4/20/18</h1>
    
    
<article>
  <div class="meta pb3-phone">
    
    <a class="series" href="https://eddieabbondanz.io/series/development" title="More Development posts">
      <i class="fas fa-th-list"></i>
      Development
    </a>
    

    
    <div class="date" title="Posted on Apr 20, 2018">
      <i class="fas fa-calendar-day"></i>
      <time>Apr 20, 2018</time>
    </div>
    
  </div>

  <div class="anchor-heading">
  <a href="#playing-around-at-the-bit-level" id="playing-around-at-the-bit-level">#</a>
  <h2>Playing Around at the Bit Level</h2>
</div><p>This weeks adventure has been exploring object serialization. Initially I was using the serializable attribute to convert my objects into byte arrays but for some objects such as the voxel chunks this is far from ideal. Since I don&rsquo;t want to handle serialization with 2 different methods I&rsquo;ve decided to bite the bullet and roll my own set up.</p>
<p>To help prepare for this task I&rsquo;ve created a BitManipulator class that allows for individual bits to be written to in a byte array. This was done to allow for writing bools as single bits vew an entire byte. The BitManipulator will be used by the ByteBuffer to help pack data as tight as possible for network traversal.</p>
<p>To limit the use of the bit manipulator it only allows for writing between 1 to 8 bits at a time. Any more than that would be unreasonable since it would be no different than writing bytes. Also by setting the upper limit to 8 it only requires us to handle 2 cases. The first when modifying only 1 byte, and the second where two (adjacent) bytes are being modified.</p>
<p>Reading bits is fairly simple.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span> ReadBits(<span style="color:#66d9ef">byte</span>[] bytes, <span style="color:#66d9ef">int</span> bitIndex, <span style="color:#66d9ef">int</span> bitCount) {
    <span style="color:#75715e">//Ensure valid use of the method.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount &lt; <span style="color:#ae81ff">1</span> || bitCount &gt; <span style="color:#ae81ff">8</span>) {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Bit count should be within the range of 1 to 8!&#34;</span>);
    }

    <span style="color:#75715e">//Figure out byte index, and where to start in the byte
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> byteIndex = bitIndex / <span style="color:#ae81ff">8</span>;
    <span style="color:#66d9ef">int</span> bitOffset = bitIndex % <span style="color:#ae81ff">8</span>;

    <span style="color:#75715e">//Reading from 1 byte
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount + bitOffset &lt;= <span style="color:#ae81ff">8</span>) {
        <span style="color:#75715e">//Build the mask
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span> mask = (<span style="color:#66d9ef">byte</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);

        <span style="color:#75715e">//Get the bits and shift them to proper location.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">byte</span>)((bytes[byteIndex] &amp; mask) &gt;&gt; bitOffset);
    }
    <span style="color:#75715e">//Reading from 2 bytes
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">//Gets the two bytes combined
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">value</span> = SerializeUtils.GetShort(bytes, byteIndex);

        <span style="color:#75715e">//Then we can pull out the data we want.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">short</span> mask = (<span style="color:#66d9ef">short</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);
        <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">byte</span>)((<span style="color:#66d9ef">value</span> &amp; mask) &gt;&gt; bitOffset);
    }
}
</code></pre></div><p>Writing bits is only a little more challenging.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> WriteBits(<span style="color:#66d9ef">byte</span>[] bytes, <span style="color:#66d9ef">int</span> bitIndex, <span style="color:#66d9ef">int</span> bitCount, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">value</span>) {
    <span style="color:#75715e">//Ensure valid use of the method.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount &lt; <span style="color:#ae81ff">1</span> || bitCount &gt; <span style="color:#ae81ff">8</span>) {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Bit count should be within the range of 1 to 8!&#34;</span>);
    }

    <span style="color:#75715e">//Divide it by 8, and find bit offset.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> byteIndex = bitIndex / <span style="color:#ae81ff">8</span>;
    <span style="color:#66d9ef">int</span> bitOffset = bitIndex % <span style="color:#ae81ff">8</span>;

    <span style="color:#75715e">//Writing into 1 byte case
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount + bitOffset &lt;= <span style="color:#ae81ff">8</span>) {
        <span style="color:#75715e">//shift to account for offset
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">value</span> &lt;&lt;= bitOffset;

        <span style="color:#75715e">//Build the mask
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span> mask = (<span style="color:#66d9ef">byte</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);

        bytes[byteIndex] &amp;= (<span style="color:#66d9ef">byte</span>)~mask;
        bytes[byteIndex] |= <span style="color:#66d9ef">value</span>;
    }
    <span style="color:#75715e">//Writing into 2 bytes case
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">//Build a short
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">short</span> splitVal = (<span style="color:#66d9ef">short</span>)(<span style="color:#66d9ef">value</span> &lt;&lt; bitOffset);
        <span style="color:#66d9ef">short</span> mask = (<span style="color:#66d9ef">short</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);

        <span style="color:#75715e">//Wipe the bits
</span><span style="color:#75715e"></span>        bytes[byteIndex] &amp;= (<span style="color:#66d9ef">byte</span>)~mask;
        bytes[byteIndex] |= (<span style="color:#66d9ef">byte</span>)splitVal;

        <span style="color:#75715e">//Write the bits
</span><span style="color:#75715e"></span>        bytes[byteIndex + <span style="color:#ae81ff">1</span>] &amp;= (<span style="color:#66d9ef">byte</span>)~(mask &gt;&gt; <span style="color:#ae81ff">8</span>);
        bytes[byteIndex + <span style="color:#ae81ff">1</span>] |= (<span style="color:#66d9ef">byte</span>)(splitVal &gt;&gt; <span style="color:#ae81ff">8</span>);
    }
}
</code></pre></div><p>I played around with using a short pointer for writing bits but it didn&rsquo;t seem worth it to require the unsafe compile flag for a single method. It was still a fun task though. I&rsquo;ve also learned about the joys of Unit Testing and have started using it for validating all my serialization methods. Once details are a little more concrete regarding the ByteBuffer set up I&rsquo;ll provide a detailed write up on it.</p>

</article>

  </main>

  <footer>
  <p>&copy; 2013 - 2024 Eddie Abbondanzio</p>
</footer>
  <script src="https://eddieabbondanz.io/js/lol.js"></script>
</body>


</html>