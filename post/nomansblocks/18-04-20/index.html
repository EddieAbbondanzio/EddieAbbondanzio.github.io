<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>No Mans Blocks - 4/20/18</title>
    <meta name="description" content="I build things. Sometimes good.">
        
    

    
    
    <link rel="stylesheet" href="https://eddieabbondanz.io/sass/main.min.2ba91e557a411cfb5bcfaee003c60eff46537304f83d0ea33f9a47c454d53cdc.css" integrity="sha256-K6keVXpBHPtbz67gA8YO/0ZTcwT4PQ6jP5pHxFTVPNw=" media="screen">

    <script src="https://eddieabbondanz.io/js/interactivity.js"></script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128571017-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

<body class="has-background-light">
    

        <section class="hero is-halfheight is-primary">
            

            <div class="hero-head"><nav class="navbar is-transparent is-spaced" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item title is-uppercase is-marginless has-text-white is-size-5" href="https://eddieabbondanz.io">
            EddieAbbondanz.io
        </a>

        <a
            role="button"
            class="navbar-burger burger has-text-white"
            aria-label="menu"
            aria-expanded="false"
            data-target="hamburger-menu"
        >
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>

    <div class="navbar-menu has-text-white">
        <div class="navbar-end">
             
            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link has-text-white"> Posts </a>

                <div class="navbar-dropdown">
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/post/"> All </a>

                    
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/series/development"> Development </a>
                    
                    <a class="navbar-item has-text-dark" href="https://eddieabbondanz.io/series/xj-build"> XJ Build </a>
                    
                </div>
            </div>

              
            <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/about" style="text-decoration: none !important"
                >About Me</a
            >
              
            <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/portfolio" style="text-decoration: none !important"
                >Portfolio</a
            >
              
            <a class="navbar-item has-text-white" href="http://github.com/EddieAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-github fa-lg"></i>
                </span>
            </a>
             
            <a class="navbar-item has-text-white" href="https://twitter.com/EAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-twitter fa-lg"></i>
                </span>
            </a>
            
            <a class="navbar-item has-text-white" href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-linkedin fa-lg"></i>
                </span>
            </a>
            
        </div>
    </div>

    <div id="hamburger-menu" class="navbar-menu is-hidden-desktop">
         

        <div class="has-dropdown is-hoverable">
            <a class="navbar-link has-text-white is-arrowless"> Posts </a>

            <div class="navbar-dropdown">
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/post/"> All </a>

                
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/series/development"> Development </a>
                
                <a class="navbar-item has-text-white" href="https://eddieabbondanz.io/series/xj-build"> XJ Build </a>
                
            </div>
        </div>
         
        <a class="navbar-item" href="https://eddieabbondanz.io/about" style="text-decoration: none !important">About Me</a>
         
        <a class="navbar-item" href="https://eddieabbondanz.io/portfolio" style="text-decoration: none !important">Portfolio</a>
        

        <div class="is-flex is-flex-direction-row is-justify-content-space-evenly">
            
            <a class="navbar-item" href="http://github.com/EddieAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-github fa-lg"></i>
                </span>
            </a>
             
            <a class="navbar-item" href="https://twitter.com/EAbbondanzio" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-twitter fa-lg"></i>
                </span>
            </a>
            
            <a class="navbar-item" href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
                <span class="icon is-medium">
                    <i class="fab fa-linkedin fa-lg"></i>
                </span>
            </a>
            
        </div>
    </div>
</nav>
</div>

            <div class="hero-foot">
                <div class="container"><header>
    <div class="post-header has-text-white has-margin-all-4-touch has-margin-bottom-4-desktop">
        
        <div class="has-margin-bottom-0">
            
            <h1 class="has-margin-bottom-0 is-size-2 is-size-4-touch">No Mans Blocks - 4/20/18</h1>
               
        </div>

        
        
        <div class="is-flex is-flex-direction-row">
            
            <div class="is-flex-desktop flex-row has-text-grey-lighter">
                <div class="is-flex is-flex-row is-align-items-baseline has-margin-right-3" title="Date posted">
                    <i class="fas fa-calendar-day has-text-grey-light has-margin-right-1"></i>
                    <time class="has-text-grey-lighter">Apr 20, 2018</time>
                </div>
            </div>
             
        </div>
        
    </div>
</header>
</div>
            </div>
        </section>
    </section>
</section>


    <main class="container has-background-white">
        
<article>
    <h2 id="playing-around-at-the-bit-level">Playing Around at the Bit Level</h2>
<p>This weeks adventure has been exploring object serialization. Initially I was using the serializable attribute to convert my objects into byte arrays but for some objects such as the voxel chunks this is far from ideal. Since I don&rsquo;t want to handle serialization with 2 different methods I&rsquo;ve decided to bite the bullet and roll my own set up.</p>
<p>To help prepare for this task I&rsquo;ve created a BitManipulator class that allows for individual bits to be written to in a byte array. This was done to allow for writing bools as single bits vew an entire byte. The BitManipulator will be used by the ByteBuffer to help pack data as tight as possible for network traversal.</p>
<p>To limit the use of the bit manipulator it only allows for writing between 1 to 8 bits at a time. Any more than that would be unreasonable since it would be no different than writing bytes. Also by setting the upper limit to 8 it only requires us to handle 2 cases. The first when modifying only 1 byte, and the second where two (adjacent) bytes are being modified.</p>
<p>Reading bits is fairly simple.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span> ReadBits(<span style="color:#66d9ef">byte</span>[] bytes, <span style="color:#66d9ef">int</span> bitIndex, <span style="color:#66d9ef">int</span> bitCount) {
    <span style="color:#75715e">//Ensure valid use of the method.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount &lt; <span style="color:#ae81ff">1</span> || bitCount &gt; <span style="color:#ae81ff">8</span>) {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Bit count should be within the range of 1 to 8!&#34;</span>);
    }

    <span style="color:#75715e">//Figure out byte index, and where to start in the byte
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> byteIndex = bitIndex / <span style="color:#ae81ff">8</span>;
    <span style="color:#66d9ef">int</span> bitOffset = bitIndex % <span style="color:#ae81ff">8</span>;

    <span style="color:#75715e">//Reading from 1 byte
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount + bitOffset &lt;= <span style="color:#ae81ff">8</span>) {
        <span style="color:#75715e">//Build the mask
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span> mask = (<span style="color:#66d9ef">byte</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);

        <span style="color:#75715e">//Get the bits and shift them to proper location.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">byte</span>)((bytes[byteIndex] &amp; mask) &gt;&gt; bitOffset);
    }
    <span style="color:#75715e">//Reading from 2 bytes
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">//Gets the two bytes combined
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">value</span> = SerializeUtils.GetShort(bytes, byteIndex);

        <span style="color:#75715e">//Then we can pull out the data we want.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">short</span> mask = (<span style="color:#66d9ef">short</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);
        <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">byte</span>)((<span style="color:#66d9ef">value</span> &amp; mask) &gt;&gt; bitOffset);
    }
}
</code></pre></div><p>Writing bits is only a little more challenging.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> WriteBits(<span style="color:#66d9ef">byte</span>[] bytes, <span style="color:#66d9ef">int</span> bitIndex, <span style="color:#66d9ef">int</span> bitCount, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">value</span>) {
    <span style="color:#75715e">//Ensure valid use of the method.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount &lt; <span style="color:#ae81ff">1</span> || bitCount &gt; <span style="color:#ae81ff">8</span>) {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Bit count should be within the range of 1 to 8!&#34;</span>);
    }

    <span style="color:#75715e">//Divide it by 8, and find bit offset.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> byteIndex = bitIndex / <span style="color:#ae81ff">8</span>;
    <span style="color:#66d9ef">int</span> bitOffset = bitIndex % <span style="color:#ae81ff">8</span>;

    <span style="color:#75715e">//Writing into 1 byte case
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bitCount + bitOffset &lt;= <span style="color:#ae81ff">8</span>) {
        <span style="color:#75715e">//shift to account for offset
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">value</span> &lt;&lt;= bitOffset;

        <span style="color:#75715e">//Build the mask
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span> mask = (<span style="color:#66d9ef">byte</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);

        bytes[byteIndex] &amp;= (<span style="color:#66d9ef">byte</span>)~mask;
        bytes[byteIndex] |= <span style="color:#66d9ef">value</span>;
    }
    <span style="color:#75715e">//Writing into 2 bytes case
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">//Build a short
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">short</span> splitVal = (<span style="color:#66d9ef">short</span>)(<span style="color:#66d9ef">value</span> &lt;&lt; bitOffset);
        <span style="color:#66d9ef">short</span> mask = (<span style="color:#66d9ef">short</span>)(((<span style="color:#ae81ff">1</span> &lt;&lt; bitCount) - <span style="color:#ae81ff">1</span>) &lt;&lt; bitOffset);

        <span style="color:#75715e">//Wipe the bits
</span><span style="color:#75715e"></span>        bytes[byteIndex] &amp;= (<span style="color:#66d9ef">byte</span>)~mask;
        bytes[byteIndex] |= (<span style="color:#66d9ef">byte</span>)splitVal;

        <span style="color:#75715e">//Write the bits
</span><span style="color:#75715e"></span>        bytes[byteIndex + <span style="color:#ae81ff">1</span>] &amp;= (<span style="color:#66d9ef">byte</span>)~(mask &gt;&gt; <span style="color:#ae81ff">8</span>);
        bytes[byteIndex + <span style="color:#ae81ff">1</span>] |= (<span style="color:#66d9ef">byte</span>)(splitVal &gt;&gt; <span style="color:#ae81ff">8</span>);
    }
}
</code></pre></div><p>I played around with using a short pointer for writing bits but it didn&rsquo;t seem worth it to require the unsafe compile flag for a single method. It was still a fun task though. I&rsquo;ve also learned about the joys of Unit Testing and have started using it for validating all my serialization methods. Once details are a little more concrete regarding the ByteBuffer set up I&rsquo;ll provide a detailed write up on it.</p>

</article>

    </main>

    <footer>
    <p>&copy; 2021 <a href="https://eddieabbondanz.io">Eddie Abbondanzio</a></p>
</footer> </body>
</html>