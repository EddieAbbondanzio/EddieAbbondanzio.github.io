<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>No Mans Blocks - 6/4/18</title>
  
  <meta name="description" content="My blog about my project cars and other contraptions">
  
  <meta name="author" content="Eddie Abbondanzio">
  

  
  
  <link rel="stylesheet" href="https://eddieabbondanz.io/sass/index.min.be8fe5de1880df9d913b8e5c1bb6443bea545015530a9120009633fc3155d422.css" integrity="sha256-vo/l3hiA352RO45cG7ZEO&#43;pUUBVTCpEgAJYz/DFV1CI=" media="screen">

  <link rel="stylesheet" href="https://eddieabbondanz.io//widgets/_plugin-vue_export-helper.css">

  <script data-goatcounter="https://tgpo.eddieabbondanz.io/count" async src="//tgpo.eddieabbondanz.io/count.js"></script>
</head>

<body>
  <nav class="navbar fr jcsb aic mt2-phone">
  <div class="title h100 fr aic">
    <a href="https://eddieabbondanz.io/">
      <img class="avatar mr2" src="https://eddieabbondanz.io/img/avatar.jpg" />
    </a>

    <a class="tdn fwb" href="https://eddieabbondanz.io/">
      <span>Eddie Abbondanzio</span>
    </a>
  </div>  

  <div id="desktop-search" class="pr2 hidden-phone" >
    
  </div>

  <div class="menu h100 aic fr-tablet dn-phone">
    
    
    <div class="item dropdown">
      <a class="trigger">Blog
        <span class="icon"><i class="fas fa-chevron-down"></i></span>
      </a>

      <div class="content">
        <a href="https://eddieabbondanz.io/post/"> All </a>

        
        <a href="https://eddieabbondanz.io/series/development">Development</a>
        
        <a href="https://eddieabbondanz.io/series/ls-xj-build">LS XJ Build</a>
        
        <a href="https://eddieabbondanz.io/series/oem&#43;-xj-build">OEM&#43; XJ Build</a>
        
        <a href="https://eddieabbondanz.io/series/93-eg-hatch-build">93 EG Hatch Build</a>
        
        <a href="https://eddieabbondanz.io/series/88-integra-build">88 Integra Build</a>
        
        <a href="https://eddieabbondanz.io/series/honda-info-and-diys">Honda Info and DIYs</a>
        
        <a href="https://eddieabbondanz.io/series/xj-info-and-diys">XJ Info and DIYs</a>
        
        <a href="https://eddieabbondanz.io/series/shop-and-tools">Shop and Tools</a>
        
      </div>
    </div>
    
    
    
    <a class="item single" href="https://eddieabbondanz.io/app">Apps</a>
    
    
    
    <a class="item single" href="https://eddieabbondanz.io/about">About</a>
    
    
    <div class="item social h100 fr aic px3">
      
      <a href="http://github.com/EddieAbbondanzio" target="_blank" title="GitHub">
        <span class="icon">
          <i class="fab fa-github fa-lg"></i>
        </span>
      </a>
      
      <a href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank" title="Linkedin">
        <span class="icon">
          <i class="fab fa-linkedin fa-lg"></i>
        </span>
      </a>
      
    </div>
  </div>

  <a id="hamburger" class="hamburger" href="#">
    <span class="icon">
      <i class="fa fa-bars fa-lg"></i>
    </span>
  </a>

</nav>
  
<div id="hamburger-menu" class="hamburger-menu">
   

  <div>
    <div id="phone-search" class="mt2">
      
    </div>
    
    <div class="ml2">
      <a href="https://eddieabbondanz.io/post/"> All </a>

      
      <a href="https://eddieabbondanz.io/series/development"> Development </a>
      
      <a href="https://eddieabbondanz.io/series/ls-xj-build"> LS XJ Build </a>
      
      <a href="https://eddieabbondanz.io/series/oem&#43;-xj-build"> OEM&#43; XJ Build </a>
      
      <a href="https://eddieabbondanz.io/series/93-eg-hatch-build"> 93 EG Hatch Build </a>
      
      <a href="https://eddieabbondanz.io/series/88-integra-build"> 88 Integra Build </a>
      
      <a href="https://eddieabbondanz.io/series/honda-info-and-diys"> Honda Info and DIYs </a>
      
      <a href="https://eddieabbondanz.io/series/xj-info-and-diys"> XJ Info and DIYs </a>
      
      <a href="https://eddieabbondanz.io/series/shop-and-tools"> Shop and Tools </a>
      
    </div>
  </div>
   
  <a href="https://eddieabbondanz.io/app">Apps</a>
   
  <a href="https://eddieabbondanz.io/about">About</a>
  

  <div class="fr jcse">
    
    <a href="http://github.com/EddieAbbondanzio" target="_blank">
      <span class="icon is-medium">
        <i class="fab fa-github fa-lg"></i>
      </span>
    </a>
    
    <a href="https://www.linkedin.com/in/ed-abbondanzio-5a7378208/" target="_blank">
      <span class="icon is-medium">
        <i class="fab fa-linkedin fa-lg"></i>
      </span>
    </a>
    
  </div>
</div>

  <main>
    
<article class="post" data-pagefind-meta="image:">
  <h1 class="h1 mb2" data-pagefind-meta="title">No Mans Blocks - 6/4/18</h1>

  <div class="fr meta pb3">
    
    <a class="mr1ch tdn" href="https://eddieabbondanz.io/series/development" title="More Development posts">
      <i class="fas fa-th-list"></i>
      Development
    </a>
    

    
    <div class="date" title="Posted on Jun 4, 2018">
      <i class="fas fa-calendar-day"></i>
      <time>Jun 4, 2018</time>
    </div>
    
  </div>

  <div class="markdown-body" data-pagefind-body>
    <h2>
  Creating Time (literally!)
  <a href="#creating-time-literally" id="creating-time-literally" class="anchor" aria-hidden="true"><i class="fa fa-link"></i></a>
</h2><p>I have a knack for forgetting what I&rsquo;ve managed to accomplish on the game during the week. To try to overcome this
so I have updates I can post on it, I&rsquo;ve started writing down each accomplishment on a sticky note.</p>
<p>Every Friday I hope to write a small blurb, and post some code showing off the current state of No Mans Blocks. While
the networking implementation is still early, I&rsquo;ve managed to get a sever-authoratative set up running that handles
syncing up lobby of players together. Players can specify their own nicknames, which will be ensured to be unique. Chat with
each other through text based messages, and some moderator functions such as kicking players are included.</p>
<p>Changelog:</p>
<ul>
<li>Switched to LiteNetLib from Lidgren. (Very happy).</li>
<li>Added custom kick message that is sent to players when kicked from a lobby.</li>
<li>Changed lobby settings to allow for picking of the next map via voting
or randomly.</li>
<li>Fixed a bug in the byte buffer that was writing a bool as a byte instead of just a bit.</li>
<li>Moved Name + description of the server to server settings instead of lobby. (The client
recieves these when their connection is accepted.)</li>
<li>Added game modes (Team Deathmatch, Deathmatch, Capture the Flag, and Demolition) more on these soon&hellip;</li>
</ul>
<p>Lastly while the switch to LiteNetLib was pretty hassle free I did have to implement my own
network synchronized time system, which is actually quite a bit easier than it sounds!</p>
<p>Both the server, and clients maintain their own time which basically just indicates how long the
game has been running for in seconds. To generate a synchronized time across the
network the following steps need to be taken.</p>
<ol>
<li>When a client connects have them send a time sync request and track when it was sent</li>
</ol>
<ul>
<li>The server then responds back with it&rsquo;s current time.</li>
<li>On the return of the sync request to the client calculate the offset from server time to
local time by subtracting the round trip time from the recieved value.</li>
</ul>
<p>These code snippets are from my TimeSynchronizer class. They are the message handlers that
process incoming messages from over the network.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> OnConnectionMessage(<span style="color:#66d9ef">object</span> sender, NetMessageArgs e) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (e.Message?.Type) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Step 1 (Client side):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//When a new server is connected to. Send it a time request.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> NetMessageType.ConnectionAccepted:
</span></span><span style="display:flex;"><span>            SendSyncRequest();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Disconnected from server. Wipe offset.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> NetMessageType.Disconnected:
</span></span><span style="display:flex;"><span>            time.SetServerOffset(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> OnTimeMessage(<span style="color:#66d9ef">object</span> sender, NetMessageArgs e) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (e.Message?.Type) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Step 3 (Client Side)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Time sync message was recieved.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> NetMessageType.TimeSync:
</span></span><span style="display:flex;"><span>            TimeSyncMessage incomingSync = e.Message <span style="color:#66d9ef">as</span> TimeSyncMessage;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (incomingSync != <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                time.SetServerOffset(incomingSync.ServerTime - timeSyncSentAt);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Step 2 (Server Side)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Client is requesting a time sync message.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> NetMessageType.TimeSyncRequest:
</span></span><span style="display:flex;"><span>            LiteNetLib.NetPeer msgSender = e.Message.Sender;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (msgSender != <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                TimeSyncMessage outgoingSync = <span style="color:#66d9ef">new</span> TimeSyncMessage(Time.LocalTime);
</span></span><span style="display:flex;"><span>                netManager.SendMessage(outgoingSync, msgSender, LiteNetLib.SendOptions.ReliableOrdered);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This process isn&rsquo;t quite perfect and a variance of several milliseconds can occur but this can be overcome by repeating these steps occasionally. It could be
taken one step further and several time syncs could be sent when a player first joins, then the average offset can be calculated from them which can reduce bad
data due to a lag spike.</p>

  </div>
</article>

  </main>

  <footer>
  <p>&copy; 2013 - 2025 Eddie Abbondanzio</p>
</footer>
  <script src="https://eddieabbondanz.io/js/lol.js"></script>
  <link href="https://eddieabbondanz.io/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="https://eddieabbondanz.io/pagefind/pagefind-ui.js"></script>

<script>
  const DRAWER_QUERY = ".pagefind-ui__drawer"

  
  window.addEventListener('DOMContentLoaded', (event) => {
    initDesktopSearchBar();
    initPhoneSearchBar();
  });

  function initDesktopSearchBar() {
    new PagefindUI({
      element: "#desktop-search", 
      showSubResults: false, 
      pageSize: 10, 
      translations: {
        placeholder: "Search posts"
      } 
    });

    
    const input = document.querySelector("#desktop-search input")
    input.addEventListener("focus", () => {
      const drawer = document.querySelector(DRAWER_QUERY)
      if(drawer) {
        drawer.classList.remove("hidden")
      }
    })

    
    window.addEventListener("click", (ev) => {
      if(!ev.target.closest("#desktop-search")) {
        const drawer = document.querySelector(DRAWER_QUERY)
        drawer.classList.add("hidden")
      }
    })
  }

  function initPhoneSearchBar() {
    new PagefindUI({
      element: "#phone-search", 
      showSubResults: false, 
      pageSize: 10, 
      translations: {
        placeholder: "Search posts"
      } 
    });

        
    const input = document.querySelector("#desktop-search input")
    input.addEventListener("focus", () => {
      const drawer = document.querySelector(DRAWER_QUERY)
      if(drawer) {
        drawer.classList.remove("hidden")
      }
    })

    
    window.addEventListener("click", (ev) => {
      if(!ev.target.closest("#desktop-search")) {
        const drawer = document.querySelector(DRAWER_QUERY)
        drawer.classList.add("hidden")
      }
    })

  }
</script>
</body>

</html>